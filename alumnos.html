<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Estudiantil - CECOVAM</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        :root { --azul: #1a2a6c; --rojo: #b21f1f; --gris: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gris); margin: 0; }
        #auth-alumno { height: 100vh; display: flex; justify-content: center; align-items: center; background: var(--azul); }
        .auth-box { background: white; padding: 30px; border-radius: 15px; width: 320px; text-align: center; }
        #dashboard-alumno { display: none; padding: 20px; }
        .section-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { background: var(--azul); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        .progress-bar { width: 0%; height: 10px; background: #27ae60; border-radius: 5px; transition: 0.3s; margin-top: 10px; }
    </style>
</head>
<body>

<div id="auth-alumno">
    <div class="auth-box">
        <h2>Acceso Alumnos</h2>
        <div style="margin-bottom:15px;">
            <button onclick="cambiarModo('login')">Ingresar</button> | <button onclick="cambiarModo('reg')">Registrarse</button>
        </div>
        <input type="text" id="al-nombre" placeholder="Nombre Completo">
        <input type="password" id="al-pass" placeholder="Clave Personal">
        <button class="btn" onclick="autenticar()">INGRESAR</button>
    </div>
</div>

<div id="dashboard-alumno">
    <div class="section-card">
        <h3>ðŸ“¤ Enviar Tarea o Archivo</h3>
        <select id="select-materia"><option value="General">Materia / Tema</option></select>
        <textarea id="comentario-tarea" placeholder="AlgÃºn comentario sobre tu entrega..."></textarea>
        
        <label>Selecciona tu archivo (PDF, Imagen, Doc):</label>
        <input type="file" id="archivo-input">
        
        <div id="progress-container" style="background:#eee; border-radius:5px; display:none;">
            <div id="upload-progress" class="progress-bar"></div>
        </div>
        
        <button class="btn" onclick="subirTareaConArchivo()" style="margin-top:10px;">SUBIR TAREA</button>
    </div>

    <div class="section-card">
        <h3>ðŸ“¢ Avisos de DirecciÃ³n</h3>
        <div id="lista-avisos"></div>
    </div>
    
    <div class="section-card">
        <h3>ðŸ’° Mis Pagos</h3>
        <div id="mis-pagos-lista"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDJh57e-sBDK0_8VtFn4EwFOyDDsm8v0lc",
        authDomain: "plataforma-cecovam.firebaseapp.com",
        projectId: "plataforma-cecovam",
        storageBucket: "plataforma-cecovam.appspot.com", // AsegÃºrate que termine en .appspot.com
        messagingSenderId: "655865798428",
        appId: "1:655865798428:web:625f020d553385e43d24d9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let alumnoLogueado = "";

    // ... (Funciones de autenticaciÃ³n idÃ©nticas a las anteriores) ...
    function cambiarModo(m) { modo = m; }
    async function autenticar() {
        const nom = document.getElementById('al-nombre').value.trim();
        const pass = document.getElementById('al-pass').value;
        if(modo === 'reg') {
            await db.collection("usuarios_alumnos").doc(nom).set({ nombre: nom, clave: pass });
            alert("Registrado");
        } else {
            const doc = await db.collection("usuarios_alumnos").doc(nom).get();
            if(doc.exists && doc.data().clave === pass) {
                alumnoLogueado = nom;
                document.getElementById('auth-alumno').style.display = 'none';
                document.getElementById('dashboard-alumno').style.display = 'block';
                cargarDatos();
            }
        }
    }

    async function subirTareaConArchivo() {
        const file = document.getElementById('archivo-input').files[0];
        const materia = document.getElementById('select-materia').value;
        const comentario = document.getElementById('comentario-tarea').value;
        
        if (!file) return alert("Por favor selecciona un archivo");

        document.getElementById('progress-container').style.display = 'block';
        
        // 1. Subir a Storage
        const storageRef = storage.ref(tareas/${alumnoLogueado}/${file.name});
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById('upload-progress').style.width = progress + '%';
            }, 
            (error) => { alert("Error al subir: " + error.message); }, 
            async () => {
                // 2. Obtener link y guardar en Firestore
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                await db.collection("actividades_alumnos").add({
                    alumno: alumnoLogueado,
                    materia: materia,
                    comentario: comentario,
                    archivoUrl: downloadURL,
                    nombreArchivo: file.name,
                    fecha: new Date().toLocaleString()
                });
                alert("Â¡Tarea enviada con Ã©xito!");
                document.getElementById('progress-container').style.display = 'none';
                document.getElementById('archivo-input').value = "";
            }
        );
    }

    function cargarDatos() {
        // (AquÃ­ van las funciones de cargar avisos y pagos que ya tenÃ­amos)
    }
</script>
</body>
</html>
